<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy å’Œ Reflect API æ¼”ç¤º</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .demo-section { margin: 20px 0; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .demo-header { background: #4CAF50; color: white; padding: 15px; }
        .demo-content { padding: 20px; }
        .btn { background: #2196F3; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #1976D2; }
        .output { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .input-group { margin: 10px 0; }
        .input-group input { padding: 8px; margin: 0 10px; border: 1px solid #ddd; border-radius: 4px; }
        .stats { display: flex; justify-content: space-around; background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .stat { text-align: center; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #2196F3; }
        .stat-label { font-size: 0.9em; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”® Proxy å’Œ Reflect API æ¼”ç¤º</h1>
        
        <!-- åŸºç¡€ä»£ç†æ¼”ç¤º -->
        <div class="demo-section">
            <div class="demo-header">
                <h3>ğŸ¯ åŸºç¡€ä»£ç†æ¼”ç¤º</h3>
            </div>
            <div class="demo-content">
                <div class="input-group">
                    <input type="text" id="userName" placeholder="å§“å">
                    <input type="number" id="userAge" placeholder="å¹´é¾„">
                    <button class="btn" onclick="updateUser()">æ›´æ–°ç”¨æˆ·</button>
                    <button class="btn" onclick="clearBasicLog()">æ¸…ç©ºæ—¥å¿—</button>
                </div>
                <div id="basicOutput" class="output">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ¼”ç¤º...</div>
            </div>
        </div>

        <!-- å“åº”å¼æ•°æ®æ¼”ç¤º -->
        <div class="demo-section">
            <div class="demo-header">
                <h3>âš¡ å“åº”å¼æ•°æ®æ¼”ç¤º</h3>
            </div>
            <div class="demo-content">
                <div class="input-group">
                    <button class="btn" onclick="incrementCount()">è®¡æ•° +1</button>
                    <button class="btn" onclick="decrementCount()">è®¡æ•° -1</button>
                    <button class="btn" onclick="addWatcher()">æ·»åŠ ç›‘å¬å™¨</button>
                </div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="countDisplay">0</div>
                        <div class="stat-label">å½“å‰è®¡æ•°</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="watcherCount">0</div>
                        <div class="stat-label">ç›‘å¬å™¨æ•°é‡</div>
                    </div>
                </div>
                <div id="reactiveOutput" class="output">å“åº”å¼ç³»ç»Ÿå°±ç»ª...</div>
            </div>
        </div>

        <!-- ç¼“å­˜ä»£ç†æ¼”ç¤º -->
        <div class="demo-section">
            <div class="demo-header">
                <h3>ğŸ’¾ æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ</h3>
            </div>
            <div class="demo-content">
                <div class="input-group">
                    <input type="number" id="calcInput" placeholder="è®¡ç®—å€¼" value="5">
                    <button class="btn" onclick="performCalculation()">æ‰§è¡Œè®¡ç®—</button>
                    <button class="btn" onclick="clearCache()">æ¸…ç©ºç¼“å­˜</button>
                </div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="cacheHits">0</div>
                        <div class="stat-label">ç¼“å­˜å‘½ä¸­</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="cacheMisses">0</div>
                        <div class="stat-label">ç¼“å­˜æœªå‘½ä¸­</div>
                    </div>
                </div>
                <div id="cacheOutput" class="output">ç¼“å­˜ç³»ç»Ÿå°±ç»ª...</div>
            </div>
        </div>

        <!-- Reflect æ¼”ç¤º -->
        <div class="demo-section">
            <div class="demo-header">
                <h3>ğŸ” Reflect æ–¹æ³•æ¼”ç¤º</h3>
            </div>
            <div class="demo-content">
                <div class="input-group">
                    <button class="btn" onclick="reflectGet()">Reflect.get()</button>
                    <button class="btn" onclick="reflectSet()">Reflect.set()</button>
                    <button class="btn" onclick="reflectHas()">Reflect.has()</button>
                    <button class="btn" onclick="reflectDelete()">Reflect.delete()</button>
                </div>
                <div id="reflectOutput" class="output">é€‰æ‹©ä¸€ä¸ª Reflect æ–¹æ³•è¿›è¡Œæ¼”ç¤º...</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let logOutput = '';
        let reactiveData = null;
        let cacheStats = { hits: 0, misses: 0 };
        let watcherCount = 0;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const colors = { info: '#3498db', success: '#27ae60', error: '#e74c3c', warning: '#f39c12' };
            logOutput += `<span style="color: ${colors[type]}">[${new Date().toLocaleTimeString()}]</span> ${message}\n`;
        }

        function updateOutput(id) {
            document.getElementById(id).innerHTML = logOutput;
        }

        function clearBasicLog() {
            logOutput = '';
            updateOutput('basicOutput');
        }

        // åŸºç¡€ä»£ç†æ¼”ç¤º
        let userProxy = null;

        function initUserProxy() {
            const user = { name: '', age: 0 };
            userProxy = new Proxy(user, {
                get(target, property) {
                    log(`ğŸ“– è¯»å–: ${property} = ${target[property]}`);
                    return Reflect.get(target, property);
                },
                set(target, property, value) {
                    if (property === 'age' && (value < 0 || value > 120)) {
                        log(`âŒ å¹´é¾„éªŒè¯å¤±è´¥: ${value}`, 'error');
                        return false;
                    }
                    log(`âœï¸ è®¾ç½®: ${property} = ${value}`, 'success');
                    return Reflect.set(target, property, value);
                }
            });
        }

        function updateUser() {
            if (!userProxy) initUserProxy();
            const name = document.getElementById('userName').value;
            const age = parseInt(document.getElementById('userAge').value);
            
            if (name) userProxy.name = name;
            if (!isNaN(age)) userProxy.age = age;
            
            updateOutput('basicOutput');
        }

        // å“åº”å¼æ•°æ®æ¼”ç¤º
        function initReactive() {
            let activeEffect = null;
            const targetMap = new WeakMap();

            function track(target, key) {
                if (!activeEffect) return;
                let depsMap = targetMap.get(target);
                if (!depsMap) targetMap.set(target, (depsMap = new Map()));
                let dep = depsMap.get(key);
                if (!dep) depsMap.set(key, (dep = new Set()));
                dep.add(activeEffect);
            }

            function trigger(target, key) {
                const depsMap = targetMap.get(target);
                if (!depsMap) return;
                const dep = depsMap.get(key);
                if (dep) dep.forEach(effect => effect());
            }

            function effect(fn) {
                activeEffect = fn;
                fn();
                activeEffect = null;
            }

            reactiveData = new Proxy({ count: 0 }, {
                get(target, key) {
                    track(target, key);
                    return Reflect.get(target, key);
                },
                set(target, key, value) {
                    const result = Reflect.set(target, key, value);
                    trigger(target, key);
                    return result;
                }
            });

            effect(() => {
                document.getElementById('countDisplay').textContent = reactiveData.count;
                logOutput = `ğŸ“Š è®¡æ•°æ›´æ–°: ${reactiveData.count}\n`;
                updateOutput('reactiveOutput');
            });
        }

        function incrementCount() {
            if (!reactiveData) initReactive();
            reactiveData.count++;
        }

        function decrementCount() {
            if (!reactiveData) initReactive();
            reactiveData.count--;
        }

        function addWatcher() {
            if (!reactiveData) initReactive();
            watcherCount++;
            document.getElementById('watcherCount').textContent = watcherCount;
            log(`ğŸ‘€ æ·»åŠ ç›‘å¬å™¨ #${watcherCount}`, 'success');
            updateOutput('reactiveOutput');
        }

        // ç¼“å­˜ä»£ç†æ¼”ç¤º
        let cachedCalc = null;

        function initCache() {
            const cache = new Map();
            
            function expensiveCalc(n) {
                let result = 0;
                for (let i = 0; i < 100000; i++) result += Math.sqrt(n);
                return result;
            }

            cachedCalc = new Proxy(expensiveCalc, {
                apply(target, thisArg, args) {
                    const key = JSON.stringify(args);
                    if (cache.has(key)) {
                        cacheStats.hits++;
                        log(`ğŸ¯ ç¼“å­˜å‘½ä¸­: ${key}`, 'success');
                        return cache.get(key);
                    }
                    cacheStats.misses++;
                    log(`ğŸ’« ç¼“å­˜æœªå‘½ä¸­: ${key}`, 'warning');
                    const result = Reflect.apply(target, thisArg, args);
                    cache.set(key, result);
                    return result;
                }
            });

            cachedCalc.clearCache = () => {
                cache.clear();
                cacheStats = { hits: 0, misses: 0 };
                log('ğŸ§¹ ç¼“å­˜å·²æ¸…ç©º', 'info');
            };
        }

        function performCalculation() {
            if (!cachedCalc) initCache();
            const input = parseInt(document.getElementById('calcInput').value) || 5;
            const result = cachedCalc(input);
            
            document.getElementById('cacheHits').textContent = cacheStats.hits;
            document.getElementById('cacheMisses').textContent = cacheStats.misses;
            
            log(`ğŸ“Š è®¡ç®—ç»“æœ: ${result.toFixed(2)}`, 'info');
            updateOutput('cacheOutput');
        }

        function clearCache() {
            if (cachedCalc) {
                cachedCalc.clearCache();
                document.getElementById('cacheHits').textContent = 0;
                document.getElementById('cacheMisses').textContent = 0;
                updateOutput('cacheOutput');
            }
        }

        // Reflect æ¼”ç¤º
        let testObj = { a: 1, b: 2, c: 3 };

        function reflectGet() {
            logOutput = '';
            log(`ğŸ” Reflect.get() æ¼”ç¤º:`);
            log(`å¯¹è±¡: ${JSON.stringify(testObj)}`);
            log(`Reflect.get(obj, 'a'): ${Reflect.get(testObj, 'a')}`, 'success');
            log(`Reflect.get(obj, 'x'): ${Reflect.get(testObj, 'x')}`, 'warning');
            updateOutput('reflectOutput');
        }

        function reflectSet() {
            logOutput = '';
            log(`âœï¸ Reflect.set() æ¼”ç¤º:`);
            const success = Reflect.set(testObj, 'd', 4);
            log(`Reflect.set(obj, 'd', 4): ${success}`, 'success');
            log(`æ›´æ–°å: ${JSON.stringify(testObj)}`);
            updateOutput('reflectOutput');
        }

        function reflectHas() {
            logOutput = '';
            log(`ğŸ” Reflect.has() æ¼”ç¤º:`);
            log(`Reflect.has(obj, 'a'): ${Reflect.has(testObj, 'a')}`, 'success');
            log(`Reflect.has(obj, 'z'): ${Reflect.has(testObj, 'z')}`, 'warning');
            updateOutput('reflectOutput');
        }

        function reflectDelete() {
            logOutput = '';
            log(`ğŸ—‘ï¸ Reflect.deleteProperty() æ¼”ç¤º:`);
            const success = Reflect.deleteProperty(testObj, 'c');
            log(`Reflect.deleteProperty(obj, 'c'): ${success}`, 'success');
            log(`åˆ é™¤å: ${JSON.stringify(testObj)}`);
            updateOutput('reflectOutput');
        }
    </script>
</body>
</html>